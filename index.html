<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Location Tracker</title>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      flex-direction: column;
    }

    #getLocationBtn {
      padding: 15px;
      font-size: 18px;
      cursor: pointer;
      background-color: #333;
      border: none;
      color: white;
      border-radius: 5px;
      outline: none;
    }

    #locationInfo,
    #handleMotionInfo {
      text-align: left;
      background-color: grey;
      border-radius: 5px;
    }

    #locationInfo {
      position: fixed;      
      top: 50px;
    }
    
    #handleMotionInfo {
      position: fixed;      
      top: 200px;
    }

    #notification {
      position: fixed;
      top: 20px;
      text-align: center;
      background-color: #ef9013;
      padding: 10px;
      border-radius: 5px;
      display: none;
    }

    #map {
      height: 400px;
      width: 100%;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <button id="getLocationBtn">Get My Location</button>
  <div id="locationInfo" class="column"></div>
  <div id="handleMotionInfo" class="column"></div>
  <div id="notification" class="column"></div>
  <div id="map" class="column"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    var map, marker;
  
    function initMap() {
      map = L.map('map').setView([0, 0], 18);
  
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);
  
      marker = L.circleMarker([0, 0], {
        radius: 10,
        color: 'blue',
        fillOpacity: 0.6,
      }).addTo(map);
  
      const locationButton = document.getElementById("getLocationBtn");
      locationButton.addEventListener("click", () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
  
              // Update marker position
              marker.setLatLng([lat, lng]);
  
              // Update map view
              map.setView([lat, lng], 18);
  
              const locationInfo = document.getElementById("locationInfo");
              locationInfo.innerHTML = `<p>Latitude: ${lat}</p><p>Longitude: ${lng}</p>`;
  
              const notification = document.getElementById("notification");
              notification.textContent = "Location updated";
              notification.style.display = "block";
  
              setTimeout(() => {
                notification.style.display = "none";
              }, 5000);
  
              document.getElementById("getLocationBtn").style.display = "none";
              document.getElementById("map").style.display = "block";
            },
            () => {
              handleLocationError(true);
            },
          );
        } else {
          handleLocationError(false);
        }
      });
    }
  
    function handleLocationError(browserHasGeolocation) {
      const locationInfo = document.getElementById("locationInfo");
      locationInfo.innerHTML = `<p>Location not available</p>`;
  
      const notification = document.getElementById("notification");
      notification.textContent = browserHasGeolocation
        ? "Error: The Geolocation service failed."
        : "Error: Your browser doesn't support geolocation.";
      notification.style.display = "block";
    }
  
    function handleMotion(event) {
      const alpha = event.alpha.toFixed(3);
      const beta = event.beta.toFixed(3);
      const gamma = event.gamma.toFixed(3);
  
      const handleMotionInfo = document.getElementById("handleMotionInfo");
      handleMotionInfo.innerHTML = `<p>Alpha: ${alpha}</p><p>Beta: ${beta}</p><p>Gamma: ${gamma}</p>`;
    }
  
    function handleMotionPermission() {
      if (isIOS) {
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission()
            .then(permissionState => {
              if (permissionState === 'granted') {
                window.addEventListener('deviceorientation', handleMotion);
              } else {
                alert('Permission denied for device orientation');
              }
            })
            .catch(error => {
              alert('Error requesting device orientation permission: ' + error);
            });
        } else {
          alert('Device orientation permission API not supported');
        }
      } else {
        // For Android, use the Permissions API
        if ('permissions' in navigator) {
          navigator.permissions.query({ name: 'accelerometer' })
            .then(permission => {
              if (permission.state === 'granted') {
                window.addEventListener('deviceorientation', handleMotion);
              } else {
                return navigator.permissions.request({ name: 'accelerometer' });
              }
            })
            .then(permissionStatus => {
              if (permissionStatus.state === 'granted') {
                window.addEventListener('deviceorientation', handleMotion);
              } else {
                alert('Permission denied for device orientation');
              }
            })
            .catch(error => {
              alert('Error checking or requesting device orientation permission: ' + error);
            });
        } else {
          alert('Device orientation permission not supported in this browser');
        }
      }
    }
  
    function handleError(error) {
      alert('Error getting location: ' + error.message);
    }
  
    document.getElementById('getLocationBtn').addEventListener('click', () => {
      if ('geolocation' in navigator) {
        const options = {
          enableHighAccuracy: true,
          timeout: 15000,
        };
  
        // Initiate both location and motion tracking simultaneously
        navigator.geolocation.watchPosition(
          (position) => {
            // Update coordinates
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
  
            // Update marker position
            marker.setLatLng([lat, lng]);
  
            // Update map view
            map.setView([lat, lng], 18);
  
            const locationInfo = document.getElementById("locationInfo");
            locationInfo.innerHTML = `<p>Latitude: ${lat}</p><p>Longitude: ${lng}</p>`;
  
            const notification = document.getElementById("notification");
            notification.textContent = "Location updated";
            notification.style.display = "block";
  
            setTimeout(() => {
              notification.style.display = "none";
            }, 5000);
  
            document.getElementById("getLocationBtn").style.display = "none";
            document.getElementById("map").style.display = "block";
          },
          handleError,
          options
        );
  
        handleMotionPermission();
      } else {
        handleLocationError(false);
      }
    });
  </script>
</body>
</html>
